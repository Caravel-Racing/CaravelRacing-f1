<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Private 3D Model Viewer — caravel-v1.fbx</title>

  <!--
    FIX SUMMARY (FBXLoader constructor not available):
    - Some sandboxes block or fail to load example loaders from unpkg
    - When FBXLoader is missing, throwing hard errors breaks the viewer

    Solution:
    - Load THREE from CDN
    - Dynamically load FBXLoader from MULTIPLE CDNs (unpkg -> jsdelivr fallback)
    - Only initialize the viewer once FBXLoader is confirmed
    - Fail gracefully with a clear UI message if all CDNs fail

    This page is locked to ONE model: caravel-v1.fbx
  -->

  <!-- three.js core (UMD global THREE) -->
  <script src="https://unpkg.com/three@0.153.0/build/three.min.js"></script>

  <!-- OrbitControls (optional) -->
  <script src="https://unpkg.com/three@0.153.0/examples/js/controls/OrbitControls.js"></script>

  <style>
    html,body { height:100%; margin:0; background:#0b0b0b; color:#eee; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial; }
    #app { height:100vh; display:flex; flex-direction:column; }
    header{ padding:12px 16px; display:flex; gap:12px; align-items:center; background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); }
    header small { opacity:0.8 }
    #viewer { position:relative; flex:1 1 auto; }
    canvas { display:block; width:100%; height:100%; }
    .meta { position:absolute; left:12px; bottom:12px; background:rgba(0,0,0,0.45); padding:8px 10px; border-radius:8px; font-size:13px }
    .warn { position:absolute; top:12px; right:12px; background:#331; color:#ffd; padding:8px 12px; border-radius:8px; font-size:13px }
    .fatal { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; text-align:center; background:#080808; color:#fbb; padding:20px }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <strong>Private 3D Viewer</strong>
      <small>(locked to <code>caravel-v1.fbx</code>)</small>
      <div style="margin-left:auto;color:#9cf; font-size:13px">Do not share this page URL</div>
    </header>

    <div id="viewer">
      <div class="meta">Model: <strong>caravel-v1.fbx</strong></div>
      <div id="controlsWarn" class="warn" style="display:none">OrbitControls unavailable — keyboard rotate enabled</div>
    </div>
  </div>
<!-- replace the old scripts with a single module script -->
<script type="module">
import * as THREE from 'https://unpkg.com/three@0.153.0/build/three.module.js';
import { OrbitControls } from 'https://unpkg.com/three@0.153.0/examples/jsm/controls/OrbitControls.js';
import { FBXLoader } from 'https://unpkg.com/three@0.153.0/examples/jsm/loaders/FBXLoader.js';

const MODEL_PATH = 'caravel-v1.fbx';

function showFatal(msg) {
  const v = document.getElementById('viewer');
  v.innerHTML = '<div class="fatal"><div>' + msg + '</div></div>';
}

try {
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0a0a0a);

  const headerHeight = document.querySelector('header').offsetHeight;
  const camera = new THREE.PerspectiveCamera(45, window.innerWidth / (window.innerHeight - headerHeight), 0.01, 2000);
  camera.position.set(0, 2, 6);

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(window.innerWidth, window.innerHeight - headerHeight);
  // keep compatibility with older/newer properties:
  if (renderer.outputColorSpace !== undefined && THREE.SRGBColorSpace !== undefined) {
    renderer.outputColorSpace = THREE.SRGBColorSpace;
  } else if (renderer.outputEncoding !== undefined && THREE.sRGBEncoding !== undefined) {
    renderer.outputEncoding = THREE.sRGBEncoding;
  }
  document.getElementById('viewer').appendChild(renderer.domElement);

  scene.add(new THREE.HemisphereLight(0xffffff, 0x222222, 0.6));
  const dir = new THREE.DirectionalLight(0xffffff, 0.8);
  dir.position.set(5, 10, 7);
  scene.add(dir);

  let controls = null;
  try {
    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
  } catch (err) {
    document.getElementById('controlsWarn').style.display = 'block';
  }

  const loader = new FBXLoader();

  let model = null;

  function frame(obj) {
    const box = new THREE.Box3().setFromObject(obj);
    const size = box.getSize(new THREE.Vector3());
    const max = Math.max(size.x, size.y, size.z);
    const center = box.getCenter(new THREE.Vector3());
    obj.position.sub(center);
    const fov = camera.fov * Math.PI / 180;
    let z = Math.abs(max / 2 / Math.tan(fov / 2)) * 1.6;
    camera.position.set(0, max * 0.3 + 0.5, z + 0.5);
    camera.near = Math.max(0.001, z / 1000);
    camera.far = z * 100;
    camera.updateProjectionMatrix();
    if (controls) {
      controls.target.set(0, max * 0.12, 0);
      controls.update();
    }
  }

  loader.load(MODEL_PATH, obj => {
    model = obj;
    scene.add(model);
    frame(model);
  }, undefined, err => {
    console.error(err);
    showFatal('Failed to load ' + MODEL_PATH + '. Make sure the file is reachable at ' + MODEL_PATH);
  });

  const key = {};
  window.addEventListener('keydown', e => key[e.key.toLowerCase()] = true);
  window.addEventListener('keyup', e => key[e.key.toLowerCase()] = false);

  function fallback(dt) {
    if (controls) return;
    const s = 1.2;
    if (key['a'] || key['arrowleft']) camera.rotation.y += s * dt;
    if (key['d'] || key['arrowright']) camera.rotation.y -= s * dt;
    if (key['w'] || key['arrowup']) camera.rotation.x += s * dt;
    if (key['s'] || key['arrowdown']) camera.rotation.x -= s * dt;
  }

  let last = performance.now();
  function loop() {
    const now = performance.now();
    const dt = (now - last) / 1000; last = now;
    if (controls) controls.update(); else fallback(dt);
    renderer.render(scene, camera);
    requestAnimationFrame(loop);
  }
  loop();

  window.addEventListener('resize', () => {
    const h = document.querySelector('header').offsetHeight;
    camera.aspect = window.innerWidth / (window.innerHeight - h);
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight - h);
  });

} catch (err) {
  console.error(err);
  showFatal('Initialization failed: ' + (err.message || err));
}
</script>

</body>
</html>